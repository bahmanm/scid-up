namespace import ::tcltest::*

source [file join [file dirname [info script]] _support support.tcl]
source [file join [::scid_test::tclDir] scidup dirs.tcl]

namespace eval ::dirs_test {
    variable savedEnv
}

proc ::dirs_test::saveEnv {name} {
    variable savedEnv
    if {[info exists ::env($name)]} {
        set savedEnv($name) [list 1 $::env($name)]
    } else {
        set savedEnv($name) [list 0 ""]
    }
}

proc ::dirs_test::restoreEnv {name} {
    variable savedEnv
    if {![info exists savedEnv($name)]} {
        return
    }
    lassign $savedEnv($name) existed value
    if {$existed} {
        set ::env($name) $value
    } else {
        unset -nocomplain ::env($name)
    }
    unset -nocomplain savedEnv($name)
}

proc ::dirs_test::setup {} {
    foreach name {SCIDUP_CONFIG_HOME XDG_CONFIG_HOME APPDATA} {
        ::dirs_test::saveEnv $name
        unset -nocomplain ::env($name)
    }
}

proc ::dirs_test::cleanup {} {
    foreach name {SCIDUP_CONFIG_HOME XDG_CONFIG_HOME APPDATA} {
        ::dirs_test::restoreEnv $name
    }
}

test dirs-configRoot-prefers-xdg-config-home-1.0 {configRoot prefers XDG_CONFIG_HOME over platform defaults} -setup {
    ::dirs_test::setup
} -body {
    set tmp [::scid_test::tempDir]
    set ::env(XDG_CONFIG_HOME) [file join $tmp xdg_home]
    set exeDir [file join $tmp exe]

    set actual [::scidup::dirs::configRoot $::tcl_platform(platform) $::tcl_platform(os) $exeDir]
    set expected [file nativename [file join $::env(XDG_CONFIG_HOME) scid-up]]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [::scid_test::tempDir] xdg_home scid-up]] \
    [file nativename [file join [::scid_test::tempDir] xdg_home scid-up]]]

test dirs-configRoot-prefers-scidup-config-home-1.0 {configRoot prefers SCIDUP_CONFIG_HOME over XDG_CONFIG_HOME} -setup {
    ::dirs_test::setup
} -body {
    set tmp [::scid_test::tempDir]
    set ::env(SCIDUP_CONFIG_HOME) [file join $tmp scidup_home]
    set ::env(XDG_CONFIG_HOME) [file join $tmp xdg_home_fallback]
    set exeDir [file join $tmp exe]

    set actual [::scidup::dirs::configRoot $::tcl_platform(platform) $::tcl_platform(os) $exeDir]
    set expected [file nativename $::env(SCIDUP_CONFIG_HOME)]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [::scid_test::tempDir] scidup_home]] \
    [file nativename [file join [::scid_test::tempDir] scidup_home]]]

test dirs-configRoot-xdg-home-wins-over-xdg-dir-1.0 {configRoot prefers XDG_CONFIG_HOME over XDG_CONFIG_DIR} -setup {
    ::dirs_test::setup
} -body {
    set tmp [::scid_test::tempDir]
    set ::env(XDG_CONFIG_HOME) [file join $tmp xdg_home2]
    set exeDir [file join $tmp exe]

    set actual [::scidup::dirs::configRoot $::tcl_platform(platform) $::tcl_platform(os) $exeDir]
    set expected [file nativename [file join $::env(XDG_CONFIG_HOME) scid-up]]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [::scid_test::tempDir] xdg_home2 scid-up]] \
    [file nativename [file join [::scid_test::tempDir] xdg_home2 scid-up]]]

test dirs-configRoot-falls-back-to-linux-config-dir-1.0 {configRoot falls back to ~/.config/scid-up on Unix when XDG is unset} -setup {
    ::dirs_test::setup
} -body {
    set exeDir [file join [::scid_test::tempDir] exe]
    set actual [::scidup::dirs::configRoot unix Linux $exeDir]
    set expected [file nativename [file join [file normalize [glob ~]] .config scid-up]]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [file normalize [glob ~]] .config scid-up]] \
    [file nativename [file join [file normalize [glob ~]] .config scid-up]]]

test dirs-configRoot-falls-back-to-macos-config-dir-1.0 {configRoot falls back to ~/Library/Application Support/scid-up on macOS when XDG is unset} -setup {
    ::dirs_test::setup
} -body {
    set exeDir [file join [::scid_test::tempDir] exe]
    set actual [::scidup::dirs::configRoot unix Darwin $exeDir]
    set expected [file nativename [file join [file normalize [glob ~]] Library {Application Support} scid-up]]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [file normalize [glob ~]] Library {Application Support} scid-up]] \
    [file nativename [file join [file normalize [glob ~]] Library {Application Support} scid-up]]]

test dirs-configRoot-falls-back-to-windows-appdata-1.0 {configRoot falls back to %APPDATA%\\scid-up on Windows when XDG is unset} -setup {
    ::dirs_test::setup
} -body {
    set ::env(APPDATA) [file join [::scid_test::tempDir] appdata]
    set exeDir [file join [::scid_test::tempDir] exe]
    set actual [::scidup::dirs::configRoot windows Windows $exeDir]
    set expected [file nativename [file join $::env(APPDATA) scid-up]]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [::scid_test::tempDir] appdata scid-up]] \
    [file nativename [file join [::scid_test::tempDir] appdata scid-up]]]

test dirs-configRoot-falls-back-to-windows-exedir-when-appdata-missing-1.0 {configRoot falls back to exeDir on Windows when APPDATA is missing} -setup {
    ::dirs_test::setup
} -body {
    set exeDir [file join [::scid_test::tempDir] exeDirFallback]
    set actual [::scidup::dirs::configRoot windows Windows $exeDir]
    set expected [file nativename $exeDir]
    list $actual $expected
} -cleanup {
    ::dirs_test::cleanup
} -result [list \
    [file nativename [file join [::scid_test::tempDir] exeDirFallback]] \
    [file nativename [file join [::scid_test::tempDir] exeDirFallback]]]
