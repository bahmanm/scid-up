package require tcltest 2.5
namespace import ::tcltest::*

source [file join [file dirname [file dirname [info script]]] _support support.tcl]

# Source the module under test.
source [file join [::scid_test::tclDir] tools fics.tcl]

namespace eval ::fics_test {
    variable stubbedCommands {}
    variable lastWritechan {}
    variable updateConsoleLines {}
    variable parseSeekCalls {}
    variable removeSeekCalls {}
    variable parseStyle12Calls {}
    variable gameclockCalls {}
    variable addMoveCalls {}
    variable drawArrowCalls {}
}

proc ::fics_test::stubCommand {name argList body} {
    variable stubbedCommands
    ::scid_test::mocks::stubCommand stubbedCommands $name $argList $body
}

proc ::fics_test::restoreStubs {} {
    variable stubbedCommands
    ::scid_test::mocks::restoreStubs stubbedCommands
}

proc ::fics_test::setup {} {
    ::fics_test::restoreStubs

    set ::fics_test::lastWritechan {}
    set ::fics_test::updateConsoleLines {}
    set ::fics_test::parseSeekCalls {}
    set ::fics_test::removeSeekCalls {}
    set ::fics_test::parseStyle12Calls {}
    set ::fics_test::gameclockCalls {}
    set ::fics_test::addMoveCalls {}
    set ::fics_test::drawArrowCalls {}

    set ::fics::soughtlist {}
    set ::fics::gamesList {}
    set ::fics::playerList {}
    set ::fics::seeklist {}

    set ::fics::offers_minelo 1000
    set ::fics::offers_maxelo 2500
    set ::fics::offers_mintime 0
    set ::fics::offers_maxtime 60

    set ::fics::logged 0
    set ::fics::isGuestLogin 0
    set ::fics::reallogin ""
    set ::fics::password ""

    set ::fics::sought 0
    set ::fics::games 0
    set ::fics::player 0

    set ::fics::graphon 0
    set ::fics::premoveEnabled 0
    set ::fics::premoveSq1 -1
    set ::fics::premoveSq2 -1
    set ::fics::playing 0
    set ::fics::observedGame -1

    set ::scid_test::sc_pos_side white
    set ::scid_test::sc_pos_fen "FEN"

    set ::scid_test::sc_game_info [dict create white "" black ""]

    # Minimal stubs required for procs under test.
    namespace eval ::gameclock {}
    ::fics_test::stubCommand ::gameclock::setSec {clockId value} {
        lappend ::fics_test::gameclockCalls [list setSec $clockId $value]
        return
    }
    ::fics_test::stubCommand ::gameclock::start {clockId} {
        lappend ::fics_test::gameclockCalls [list start $clockId]
        return
    }
    ::fics_test::stubCommand ::gameclock::stop {clockId} {
        lappend ::fics_test::gameclockCalls [list stop $clockId]
        return
    }
}

proc ::fics_test::cleanup {} {
    ::fics_test::restoreStubs

    unset -nocomplain ::scid_test::sc_pos_side
    unset -nocomplain ::scid_test::sc_pos_fen

    set ::fics::soughtlist {}
    set ::fics::gamesList {}
    set ::fics::playerList {}
    set ::fics::seeklist {}

    set ::fics::sought 0
    set ::fics::games 0
    set ::fics::player 0

    set ::fics::graphon 0
    set ::fics::premoveEnabled 0
    set ::fics::premoveSq1 -1
    set ::fics::premoveSq2 -1
    set ::fics::playing 0
    set ::fics::observedGame -1

    catch {after cancel ::fics::stayConnected}
}

test fics-parseSoughtLine-1.0 {parseSoughtLine accepts a valid sought line (with colour)} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::soughtlist {}
        set line {fics% 12 1500 Alice 5 0 rated blitz [white] 1400-1600}

        # Act
        set ok [::fics::parseSoughtLine $line]
        array set ga [lindex $::fics::soughtlist 0]

        # Assert
        return [list $ok $ga(game) $ga(elo) $ga(name) $ga(time_init) $ga(time_inc) $ga(rated) $ga(type) $ga(color) $ga(rating_range)]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {1 12 1500 Alice 5 0 rated blitz {[white]} 1400-1600}

test fics-parseSoughtLine-2.0 {parseSoughtLine clamps invalid elo to offers_minelo} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::offers_minelo 1000
        set ::fics::soughtlist {}
        set line "13 ???? Bob 3 0 unrated standard 1000-2000"

        # Act
        set ok [::fics::parseSoughtLine $line]
        array set ga [lindex $::fics::soughtlist 0]

        # Assert
        return [list $ok $ga(game) $ga(elo) $ga(name) $ga(rated) $ga(type)]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {1 13 1000 Bob unrated standard}

test fics-parseSoughtLine-3.0 {parseSoughtLine rejects invalid rated/type fields} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::soughtlist {}

        # Act
        set ok1 [::fics::parseSoughtLine "1 1500 A 5 0 maybe blitz 1000-2000"]
        set ok2 [::fics::parseSoughtLine "2 1500 A 5 0 rated bullet 1000-2000"]

        # Assert
        return [list $ok1 $ok2 [llength $::fics::soughtlist]]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {0 0 0}

test fics-parseGamesLine-1.0 {parseGamesLine parses a games list row} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::gamesList {}
        set line {fics% 1 1500 Alice 1600 Bob [br 5 0}

        # Act
        set ok [::fics::parseGamesLine $line]

        # Assert
        return [list $ok [lindex $::fics::gamesList 0]]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list 1 [list 1 1500 Alice 1600 Bob " br" "5 0"]]

test fics-parseWhoLine-1.0 {parseWhoLine parses a player row and extracts title/playing status} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::playerList {}
        set line " |001X   Alice(GM) 1500 1600 1700 0 |"

        # Act
        set ok [::fics::parseWhoLine $line]

        # Assert
        return [list $ok [lindex $::fics::playerList 0]]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list 1 [list {(GM)} Alice {X   p} 1500 1600 1700 0 {}]]

test fics-parseWhoLine-2.0 {parseWhoLine ignores frame and header lines} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::playerList {}

        # Act
        set ok1 [::fics::parseWhoLine " +------------------------------------------------+"]
        set ok2 [::fics::parseWhoLine " |000X   User 0 0 0 0 0"]

        # Assert
        return [list $ok1 $ok2 [llength $::fics::playerList]]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {1 1 0}

test fics-parseSeek-1.0 {parseSeek appends a seek entry with recognised fields} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::seeklist {}
        set line "<s> 123 w=Bob ti=GM rt=1600 t=5 i=0 r=rated tp=blitz c=W rr=1000-2000 a=1 f=0"

        # Act
        ::fics::parseSeek $line
        array set seekelt [lindex $::fics::seeklist 0]

        # Assert
        return [list \
            $seekelt(index) \
            $seekelt(name_from) \
            $seekelt(titles) \
            $seekelt(rating) \
            $seekelt(time) \
            $seekelt(increment) \
            $seekelt(rated) \
            $seekelt(type) \
            $seekelt(color) \
            $seekelt(rating_range) \
            $seekelt(automatic) \
            $seekelt(formula_checked) \
        ]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {123 Bob GM 1600 5 0 rated blitz W 1000-2000 1 0}

test fics-removeSeek-1.0 {removeSeek removes seek entries from seeklist} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::seeklist [list \
            [list index 12 name_from A] \
            [list index 34 name_from B] \
        ]

        # Act
        ::fics::removeSeek "<sr> 12"

        # Assert
        array set remaining [lindex $::fics::seeklist 0]
        return [list [llength $::fics::seeklist] $remaining(index) $remaining(name_from)]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {1 34 B}

test fics-setPremove-1.0 {setPremove sets premove and draws an arrow when enabled} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::premoveEnabled 1
        set ::fics::playing -1
        set ::highlightLastMoveColor "X"
        namespace eval ::board::mark {}
        ::fics_test::stubCommand ::board::mark::DrawArrow {board sq1 sq2 colour} {
            lappend ::fics_test::drawArrowCalls [list $board $sq1 $sq2 $colour]
            return
        }

        # Act
        set ok [::fics::setPremove 12 34]

        # Assert
        return [list $ok $::fics::premoveSq1 $::fics::premoveSq2 $::fics_test::drawArrowCalls]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list 1 12 34 [list [list .main.board.bd 12 34 X]]]

test fics-makePremove-1.0 {makePremove submits the premove when switching to playing} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::premoveEnabled 1
        set ::fics::playing 1
        set ::fics::premoveSq1 12
        set ::fics::premoveSq2 34
        ::fics_test::stubCommand addMove {sqTo sqFrom} {
            lappend ::fics_test::addMoveCalls [list $sqTo $sqFrom]
            return
        }

        # Act
        ::fics::makePremove

        # Assert
        return [list $::fics_test::addMoveCalls $::fics::premoveSq1]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list [list [list 12 34]] -1]

test fics-playerCanMove-1.0 {playerCanMove clears stale premove when waiting and FICS window exists} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::premoveEnabled 1
        set ::fics::playing -1
        set ::fics::premoveSq1 12

        ::fics_test::stubCommand winfo {subcmd args} {
            switch -- $subcmd {
                exists { return 1 }
                default { error "winfo $subcmd not stubbed in this test" }
            }
        }

        ::fics_test::stubCommand .main.board.bd {subcmd args} {
            if {$subcmd ne "delete" || [lindex $args 0] ne "mark"} {
                error ".main.board.bd $subcmd not stubbed in tests"
            }
            return
        }

        # Act
        set ok [::fics::playerCanMove]

        # Assert
        return [list $ok $::fics::premoveSq1]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {1 -1}

test fics-parseStyle12-1.0 {parseStyle12 updates clocks and state without reconstructing game when FEN matches} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::premoveEnabled 0
        set ::fics::graphon 0
        set ::scid_test::sc_pos_fen "8/8/8/8/8/8/8/8 w - - 0 1"

        # A minimal style12 line: empty board, white to move, no castling/ep.
        set line [list \
            <12> \
            -------- -------- -------- -------- -------- -------- -------- -------- \
            W -1 0 0 0 0 0 \
            42 \
            WhitePlayer BlackPlayer \
            -1 \
            5 0 \
            0 0 \
            120 120 \
            1 \
            none \
            0 \
            none \
        ]

        # Guard against accidental heavy path (game reconstruction).
        ::fics_test::stubCommand sc_base {subcmd args} { error "sc_base should not be called in this test" }
        ::fics_test::stubCommand sc_game {subcmd args} { error "sc_game should not be called in this test" }

        # Act
        ::fics::parseStyle12 $line

        # Assert
        return [list $::fics::playing $::fics::observedGame $::fics_test::gameclockCalls]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list -1 42 [list [list setSec 1 -120] [list setSec 2 -120] [list start 1] [list stop 2]]]

test fics-setProfileVars-1.0 {setProfileVars copies profileVars into findopponent when present} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        array set ::fics::profileVars {}
        array set ::fics::findopponent {}
        set login "alice"
        set ::fics::profileVars(initTime_$login) 5
        set ::fics::profileVars(incTime_$login) 2
        set ::fics::profileVars(rated_$login) rated
        set ::fics::profileVars(color_$login) white
        set ::fics::profileVars(limitrating_$login) 1
        set ::fics::profileVars(rating1_$login) 1200
        set ::fics::profileVars(rating2_$login) 1800
        set ::fics::profileVars(manual_$login) 0
        set ::fics::profileVars(formula_$login) 1

        # Act
        ::fics::setProfileVars $login

        # Assert
        return [list \
            $::fics::findopponent(initTime) \
            $::fics::findopponent(incTime) \
            $::fics::findopponent(rated) \
            $::fics::findopponent(color) \
            $::fics::findopponent(limitrating) \
            $::fics::findopponent(rating1) \
            $::fics::findopponent(rating2) \
            $::fics::findopponent(manual) \
            $::fics::findopponent(formula) \
        ]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {5 2 rated white 1 1200 1800 0 1}

test fics-syncProfileVars-1.0 {syncProfileVars copies findopponent into profileVars (guest-aware)} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        array set ::fics::profileVars {}
        array set ::fics::findopponent {}
        set ::fics::findopponent(initTime) 10
        set ::fics::findopponent(incTime) 1
        set ::fics::findopponent(rated) unrated
        set ::fics::findopponent(color) black
        set ::fics::findopponent(limitrating) 0
        set ::fics::findopponent(rating1) 1000
        set ::fics::findopponent(rating2) 2000
        set ::fics::findopponent(manual) 1
        set ::fics::findopponent(formula) 0

        set ::fics::isGuestLogin 1

        # Act
        ::fics::syncProfileVars "ignored"

        # Assert
        return [list \
            $::fics::profileVars(initTime_guest) \
            $::fics::profileVars(incTime_guest) \
            $::fics::profileVars(rated_guest) \
            $::fics::profileVars(color_guest) \
            $::fics::profileVars(rating1_guest) \
            $::fics::profileVars(rating2_guest) \
        ]
    } \
    -cleanup {::fics_test::cleanup} \
    -result {10 1 unrated black 1000 2000}

test fics-play-1.0 {play sends the play command and sets observedGame} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        ::fics_test::stubCommand ::fics::writechan {line {echo "noecho"}} {
            set ::fics_test::lastWritechan [list $line $echo]
            return
        }

        # Act
        ::fics::play 77

        # Assert
        return [list $::fics_test::lastWritechan $::fics::observedGame]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list [list "play 77" noecho] 77]

test fics-writechan-1.0 {writechan is a no-op when not connected} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::sockchan ""
        ::fics_test::stubCommand ::fics::updateConsole {line} {
            lappend ::fics_test::updateConsoleLines $line
            return
        }

        # Act
        ::fics::writechan "date" "echo"

        # Assert
        return $::fics_test::updateConsoleLines
    } \
    -cleanup {::fics_test::cleanup} \
    -result {}

test fics-writechan-2.0 {writechan writes to channel and echoes to console when requested} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set path [file join [::scid_test::tempDir] "fics_sockchan.txt"]
        set ch [open $path w+]
        fconfigure $ch -buffering line
        set ::fics::sockchan $ch

        ::fics_test::stubCommand ::fics::updateConsole {line} {
            lappend ::fics_test::updateConsoleLines $line
            return
        }

        # Act
        ::fics::writechan "hello" "echo"
        flush $ch
        seek $ch 0 start
        set content [read $ch]
        close $ch
        set ::fics::sockchan ""

        # Assert
        return [list $content $::fics_test::updateConsoleLines]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list "hello\n" [list "->>hello"]]

test fics-storeTime-1.0 {storeTime maps side-to-move to gameclock side id} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        namespace eval ::gameclock {}
        ::fics_test::stubCommand ::gameclock::storeTimeComment {sideId} {
            lappend ::fics_test::gameclockCalls [list storeTimeComment $sideId]
            return
        }

        # Act
        set ::scid_test::sc_pos_side black
        ::fics::storeTime
        set ::scid_test::sc_pos_side white
        ::fics::storeTime

        # Assert
        return $::fics_test::gameclockCalls
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list [list storeTimeComment 1] [list storeTimeComment 2]]

test fics-readparse-1.0 {readparse routes special protocol lines and avoids updateConsole} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::sought 0
        set ::fics::seeklist [list a b]

        ::fics_test::stubCommand ::fics::updateConsole {line} {
            lappend ::fics_test::updateConsoleLines $line
            return
        }
        ::fics_test::stubCommand ::fics::parseSeek {line} {
            lappend ::fics_test::parseSeekCalls $line
            return
        }
        ::fics_test::stubCommand ::fics::removeSeek {line} {
            lappend ::fics_test::removeSeekCalls $line
            return
        }
        ::fics_test::stubCommand ::fics::parseStyle12 {line} {
            lappend ::fics_test::parseStyle12Calls $line
            return
        }

        # Act
        ::fics::readparse "<sc> reset seeks"
        ::fics::readparse "<s> 10 w=Bob"
        ::fics::readparse "<sr> 10"
        ::fics::readparse "<12> dummy"

        # Assert
        return [list $::fics::seeklist $::fics_test::parseSeekCalls $::fics_test::removeSeekCalls $::fics_test::parseStyle12Calls $::fics_test::updateConsoleLines]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list {} [list "<s> 10 w=Bob"] [list "<sr> 10"] [list "<12> dummy"] {}]

test fics-readparse-3.0 {readparse parses sought output when in sought mode} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::sought 1

        ::fics_test::stubCommand ::fics::updateConsole {line} {
            lappend ::fics_test::updateConsoleLines $line
            return
        }
        ::fics_test::stubCommand ::fics::parseSoughtLine {line} {
            lappend ::fics_test::parseSeekCalls $line
            return 1
        }

        # Act
        ::fics::readparse {fics% 12 1500 Alice 5 0 rated blitz [white] 1400-1600}

        # Assert
        return [list $::fics_test::parseSeekCalls $::fics_test::updateConsoleLines]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list [list {fics% 12 1500 Alice 5 0 rated blitz [white] 1400-1600}] {}]

test fics-readparse-2.0 {readparse handles login prompt and sets logged for guest} \
    -setup {::fics_test::setup} \
    -body {
        # Arrange
        set ::fics::reallogin "guest"
        set ::fics::isGuestLogin 1

        ::fics_test::stubCommand ::fics::writechan {line {echo "noecho"}} {
            set ::fics_test::lastWritechan [list $line $echo]
            return
        }

        # Act
        ::fics::readparse "login: "

        # Assert
        return [list $::fics_test::lastWritechan $::fics::logged]
    } \
    -cleanup {::fics_test::cleanup} \
    -result [list [list guest noecho] 1]

tcltest::cleanupTests
