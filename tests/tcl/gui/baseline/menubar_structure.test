package require tcltest 2.5
namespace import ::tcltest::*

set tclTestsDir [file dirname [file dirname [file dirname [info script]]]]
source [file join $tclTestsDir _support support.tcl]

namespace eval ::gui_menubar_baseline_test {
    variable stubbedCommands {}
}

proc ::gui_menubar_baseline_test::setup {} {
    ::scid_test::mocks::restoreStubs ::gui_menubar_baseline_test::stubbedCommands
    ::scid_test::menu_capture::reset

    ::scid_test::menu_capture::install ::gui_menubar_baseline_test::stubbedCommands \
        -defaultTearoff 1 \
        -stubBind 1

    # Minimal globals expected during file-scope menu initialisation.
    set ::macOS 0
    set ::windowsOS 0
    set ::languages {E}
    set ::language E
    set ::langName(E) "English"
    set ::langUnderline(E) 0

    # Force token-based labels regardless of any translation tables that may be
    # initialised by sourced modules.
    ::scid_test::mocks::stubCommand ::gui_menubar_baseline_test::stubbedCommands tr {tag {lang ""}} {
        return $tag
    }
}

proc ::gui_menubar_baseline_test::cleanup {} {
    ::scid_test::mocks::restoreStubs ::gui_menubar_baseline_test::stubbedCommands
    ::scid_test::menu_capture::reset
}

test gui-menubar-baseline-compare-1.0 {Main menu bar matches the approved baseline structure} -setup {
    ::gui_menubar_baseline_test::setup
} -body {
    # Arrange/Act: source the menu definitions under the harness.
    source [file join [::scid_test::tclDir] menus.tcl]

    set snapshot [::scid_test::menu_structure::snapshot .menu \
        -dynamicMenus [::scid_test::menu_structure::defaultDynamicMenus]]

    set actual [::scid_test::menu_structure::format $snapshot]

    set baselineFile [file join [file dirname [info script]] menubar_structure.linux-x11.baseline]

    if {[info exists ::env(SCIDUP_UPDATE_UI_BASELINES)] && $::env(SCIDUP_UPDATE_UI_BASELINES) ne ""} {
        ::scid_test::baseline_io::writeListFile $baselineFile $actual [list \
            "ScidUp UI baseline: main menu bar (Linux/X11)" \
            "Generated by: SCIDUP_UPDATE_UI_BASELINES=1 tclsh tests/tcl/run_one_test.tcl gui/baseline/menubar_structure.test" \
        ]
        return 1
    }

    set expected [::scid_test::baseline_io::readListFile $baselineFile]

    if {$expected ne $actual} {
        set diff [::scid_test::baseline_io::unifiedDiff $expected $actual]
        error "Menubar baseline mismatch: $baselineFile\n\n$diff"
    }

    return 1
} -cleanup {
    ::gui_menubar_baseline_test::cleanup
} -result 1

cleanupTests
