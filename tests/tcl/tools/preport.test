package require tcltest 2.5
namespace import ::tcltest::*

source [file join [file dirname [file dirname [info script]]] _support support.tcl]

# Minimal utilities used by `preport::report`.
namespace eval ::utils {}
namespace eval ::utils::date {}
namespace eval ::utils::string {}

if {![llength [info commands ::utils::date::today]]} {
    proc ::utils::date::today {} {
        return "2020-01-02"
    }
}

if {![llength [info commands ::utils::thousands]]} {
    proc ::utils::thousands {n} { return $n }
}

# `preport::report` depends on `::optable::_docStart/_docEnd` and optable helpers.
namespace eval ::optable {}
array set ::optable::_docStart {}
array set ::optable::_docEnd {}

if {![llength [info commands ::optable::stats]]} {
    proc ::optable::stats {fmt} { return "<STATS fmt=$fmt>" }
}
if {![llength [info commands ::optable::results]]} {
    proc ::optable::results {reportType fmt} { return "<RESULTS type=$reportType fmt=$fmt>" }
}

# Source the module under test.
source [file join [::scid_test::tclDir] tools preport.tcl]

namespace eval ::preport_test {
    variable stubbedCommands {}
    variable scReportCalls {}
}

proc ::preport_test::stubCommand {name argList body} {
    variable stubbedCommands
    ::scid_test::mocks::stubCommand stubbedCommands $name $argList $body
}

proc ::preport_test::restoreStubs {} {
    variable stubbedCommands
    ::scid_test::mocks::restoreStubs stubbedCommands
}

proc ::preport_test::setup {} {
    ::preport_test::restoreStubs

    # Arrange
    set ::curr_db 1
    set ::scidVersion "test"

    array unset ::tr
    array set ::tr {
        games games
        moves moves
        PReportTitle "Player Report"
        Player "Player"
        PReportColorWhite "(White)"
        PReportColorBlack "(Black)"
        PReportMoves "Moves: %s"
        Database "Database"
        ECO ECO
        OprepGenerated "Generated by"
        OprepTheoryTable "Theory Table"
        OprepTableComment "Limited to %d games"
    }

    # Default report options off unless a test enables them.
    array unset ::preport
    array set ::preport {
        Stats 0
        Oldest 0
        Newest 0
        MostFrequentOpponents 0
        Results 0
        AvgPerf 0
        HighRating 0
        MostFrequentEcoCodes 0
        Themes 0
        Endgames 0
        MaxGames 400
    }

    set ::preport::_player "Alice"
    set ::preport::_color white
    set ::preport::_pos start

    # Provide doc wrappers.
    set ::optable::_docStart(text) {[OprepTitle]
}
    set ::optable::_docEnd(text) "\n<END>"
    set ::optable::_docStart(ctext) ""
    set ::optable::_docEnd(ctext) ""
    set ::optable::_docStart(html) ""
    set ::optable::_docEnd(html) ""
    set ::optable::_docStart(latex) ""
    set ::optable::_docEnd(latex) ""

    set ::preport_test::scReportCalls {}

    ::preport_test::stubCommand sc_base {subcmd args} {
        switch -- $subcmd {
            filename { return "/tmp/testbase.si4" }
            numGames { return 123 }
            default { error "sc_base $subcmd not stubbed in preport tests" }
        }
    }

    ::preport_test::stubCommand sc_pos {subcmd args} {
        if {$subcmd eq "isAt" && [lindex $args 0] eq "start"} { return 1 }
        error "sc_pos $subcmd not stubbed in preport tests"
    }

    ::preport_test::stubCommand sc_report {domain subcmd args} {
        lappend ::preport_test::scReportCalls [list $domain $subcmd {*}$args]
        if {$domain ne "player"} { error "sc_report domain $domain not stubbed" }
        switch -- $subcmd {
            format { return }
            notes { return }
            count { return [list 3 5] }
            line { return "1. e4" }
            eco { return "C20" }
            print {
                # `sc_report player print <numRows> <secText> <comment>`
                lassign $args numRows secText comment
                return "<PRINT sec=$secText comment=$comment>"
            }
            default { error "sc_report $domain $subcmd not stubbed in preport tests" }
        }
    }
}

proc ::preport_test::cleanup {} {
    ::preport_test::restoreStubs
    unset -nocomplain ::curr_db
    unset -nocomplain ::scidVersion
    array unset ::tr
    array unset ::preport
}

test preport-_reset-1.0 {preport::_reset initialises section counters} -setup {
    ::preport_test::setup
} -body {
    # Arrange
    set ::preport::_data(sec) 9
    set ::preport::_data(subsec) 7

    # Act
    ::preport::_reset

    # Assert
    list $::preport::_data(sec) $::preport::_data(subsec)
} -cleanup {
    ::preport_test::cleanup
} -result {0 0}

test preport-_sec-_subsec-1.0 {preport::_sec and _subsec number sections in html format} -setup {
    ::preport_test::setup
} -body {
    # Arrange
    set ::preport::_data(fmt) "html"
    ::preport::_reset

    # Act
    set sec [::preport::_sec "Statistics"]
    set sub1 [::preport::_subsec "Results"]

    # Assert
    list $sec $sub1 $::preport::_data(sec) $::preport::_data(subsec)
} -cleanup {
    ::preport_test::cleanup
} -result [list "\n<h2>1. Statistics</h2>\n" "\n<h3>1.1 Results</h3>\n\n" 1 1]

test preport-report-text-minimal-1.0 {preport::report emits title, player line, db line, and doc wrappers} -setup {
    ::preport_test::setup
} -body {
    # Arrange
    set ::preport::_player "Alice"
    set ::preport::_color white
    set ::preport::_pos start

    # Act
    set out [::preport::report text 0]

    # Assert
    set expected [list \
        [list player format text] \
        [list player notes 0 0] \
        [list player count]]
    if {$::preport_test::scReportCalls ne $expected} {
        error "Unexpected sc_report calls: $::preport_test::scReportCalls"
    }

    # Assert
    list \
        [string match "Player Report*" $out] \
        [string match "*Player: \"Alice\" (White)*" $out] \
        [string match "*Database: testbase.si4 (123 games)*" $out] \
        [string match "*<END>" $out]
} -cleanup {
    ::preport_test::cleanup
} -result {1 1 1 1}

test preport-report-currentpos-includes-moves-and-eco-1.0 {preport::report includes move sequence and ECO when using current position} -setup {
    ::preport_test::setup

    # Arrange: current position is not start.
    ::preport_test::stubCommand sc_pos {subcmd args} {
        if {$subcmd eq "isAt" && [lindex $args 0] eq "start"} { return 0 }
        error "sc_pos $subcmd not stubbed in preport tests"
    }

    set ::preport::_pos current
} -body {
    # Arrange

    # Act
    set out [::preport::report text 0]

    # Assert
    set expected [list \
        [list player format text] \
        [list player notes 0 0] \
        [list player count] \
        [list player line] \
        [list player eco]]
    if {$::preport_test::scReportCalls ne $expected} {
        error "Unexpected sc_report calls: $::preport_test::scReportCalls"
    }

    # Assert
    list \
        [string match "*Moves: 1. e4*" $out] \
        [string match "*ECO: C20*" $out]
} -cleanup {
    ::preport_test::cleanup
} -result {1 1}

test preport-report-ctext-adds-select-run-1.0 {preport::report in ctext includes select-all run wrapper} -setup {
    ::preport_test::setup
} -body {
    # Arrange

    # Act
    set out [::preport::report ctext 0]

    # Assert
    set expected [list \
        [list player format ctext] \
        [list player notes 0 0] \
        [list player count]]
    if {$::preport_test::scReportCalls ne $expected} {
        error "Unexpected sc_report calls: $::preport_test::scReportCalls"
    }

    # Assert
    string match "*<run sc_report player select all 0; ::notify::filter 1 dbfilter>*" $out
} -cleanup {
    ::preport_test::cleanup
} -result 1

test preport-report-withTable-uses-comment-1.0 {preport::report passes table comment when truncating by MaxGames} -setup {
    ::preport_test::setup

    set ::preport(MaxGames) 100

    # Arrange: more total games than MaxGames.
    ::preport_test::stubCommand sc_report {domain subcmd args} {
        lappend ::preport_test::scReportCalls [list $domain $subcmd {*}$args]
        if {$domain ne "player"} { error "sc_report domain $domain not stubbed" }
        switch -- $subcmd {
            format { return }
            notes { return }
            count { return [list 3 200] }
            line { return "" }
            eco { return "" }
            print {
                lassign $args numRows secText comment
                return "<PRINT sec=$secText comment=$comment>"
            }
            default { error "sc_report $domain $subcmd not stubbed in preport tests" }
        }
    }
} -body {
    # Arrange

    # Act
    set out [::preport::report text 1]

    # Assert
    set calls $::preport_test::scReportCalls
    set expectedPrefix [list \
        [list player format text] \
        [list player notes 1 0] \
        [list player count]]
    if {[llength $calls] != 4} {
        error "Unexpected sc_report call count: [llength $calls] ($calls)"
    }
    if {[lrange $calls 0 2] ne $expectedPrefix} {
        error "Unexpected sc_report call prefix: [lrange $calls 0 2]"
    }

    set printCall [lindex $calls 3]
    if {[lindex $printCall 0] ne "player" || [lindex $printCall 1] ne "print"} {
        error "Expected sc_report player print call, got: $printCall"
    }
    if {[lindex $printCall 2] ne 0} {
        error "Expected sc_report player print numRows=0, got: $printCall"
    }
    if {[string length [lindex $printCall 3]] == 0} {
        error "Expected sc_report player print secText to be non-empty"
    }
    if {[lindex $printCall 4] ne "Limited to 100 games"} {
        error "Expected sc_report player print comment=Limited to 100 games, got: $printCall"
    }

    # Assert
    string match "*comment=Limited to 100 games*" $out
} -cleanup {
    ::preport_test::cleanup
} -result 1
